<!DOCTYPE html>
<html lang="en-us">

<head>
  <title>Eth智能合约签名校验 - 可用于实现多签合约 | ZhongXuQi的技术博客</title>

  <meta charset="UTF-8">
  <meta name="language" content="en">
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  
  
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Eth智能合约签名校验 - 可用于实现多签合约" />
  <meta name="twitter:description" content=""/>
  <meta name="twitter:site" content="https://twitter.com/zhongxuqi" />
  <meta name="twitter:creator" content="https://twitter.com/zhongxuqi" />
  

  <link rel="shortcut icon" type="image/png" href="/favicon.ico" />


  
  
    
 
  
  
  
  
  
  
    
    <link type="text/css" rel="stylesheet" href="/css/post.min.86d1effd4c412b85ac13db53a90c473a0f256f789b821e131125c9aa25cb6a6d.css" integrity="sha256-htHv/UxBK4WsE9tTqQxHOg8lb3ibgh4TESXJqiXLam0="/>
  
    
    <link type="text/css" rel="stylesheet" href="/css/custom.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css" integrity="sha256-47DEQpj8HBSa&#43;/TImW&#43;5JCeuQeRkm5NMpJWZG3hSuFU="/>
  
  
   
   
    

<script type="application/ld+json">
  
    { 
      "@context": "http://schema.org", 
      "@type": "WebSite", 
      "url": "https:\/\/zhongxuqi.github.io\/blockchain\/2022-03-27\/",
      "name": "Eth智能合约签名校验 - 可用于实现多签合约",
      "author": {
        "@type": "Person",
        "name": ""
      },
      "description": ""
    }
  
  </script>
</head>

<body>
  <div class="burger__container">
  <div class="burger" aria-controls="navigation" aria-label="Menu">
    <div class="burger__meat burger__meat--1"></div>
    <div class="burger__meat burger__meat--2"></div>
    <div class="burger__meat burger__meat--3"></div>
  </div>
</div>
 

  <nav class="nav" id="navigation">
  <ul class="nav__list">
    
    
      <li>
        <a  href="/">主页</a>
      </li>
    
      <li>
        <a  class="active"
         href="/blockchain">区块链</a>
      </li>
    
      <li>
        <a  href="/mobile">移动端开发</a>
      </li>
    
      <li>
        <a  href="/acm">ACM</a>
      </li>
    
      <li>
        <a  href="/tools">开发工具</a>
      </li>
    
  </ul>
</nav>


  <main>
    
    

    <div class="flex-wrapper">
      <div class="post__container">
        <div class="post">
          <header class="post__header">
            <h1 id="post__title">Eth智能合约签名校验 - 可用于实现多签合约</h1>
            <time datetime="2022-03-27 08:08:21 &#43;0800 CST" class="post__date">Mar 27 2022</time> 
          </header>
          <article class="post__content">
              
<h2 id="1-对message进行签名">1. 对message进行签名<a class="anchor" href="#1-对message进行签名">#</a></h2>
<pre><code class="language-python">from eth_account.messages import encode_defunct
from web3 import Web3
from eth_keys import keys

KEY = ... # 填写账户私钥
w3 = Web3(Web3.HTTPProvider(&lt;input eth node url/&gt;)) # 请填写以太坊的节点url
account = w3.eth.account.from_key(KEY)
print('address: ', account.address)
rawText = 'hello' # 签名message
signedMessage = account.sign_message(encode_defunct(text=rawText))
print('message hash: ', signedMessage.messageHash.hex())
# print(signedMessage)
print('v: ', int(signedMessage.v))
print('r: ', hex(signedMessage.r))
print('s: ', hex(signedMessage.s))
print('signature: ', signedMessage.signature.hex())
print(w3.eth.account.recover_message(encode_defunct(text=rawText), signature=signedMessage.signature))
</code></pre>
<h2 id="2-执行脚本得到">2. 执行脚本，得到<a class="anchor" href="#2-执行脚本得到">#</a></h2>
<pre><code class="language-bash">address:  0x1c74c86906d91766e143e1d009C8604b66001363
message hash:  0x50b2c43fd39106bafbba0da34fc430e1f91e3c96ea2acee2bc34119f92b37750
v:  28
r:  0x5a0121bea4f2c1e9e6aad76bd3e06191a533c0b53a77df31e3b6310dbf4f698f
s:  0x17216a4bfd7cf812bf2a6d9b44122c807880a5cb3de403d4baa8e0fb352189dd
signature:  0x5a0121bea4f2c1e9e6aad76bd3e06191a533c0b53a77df31e3b6310dbf4f698f17216a4bfd7cf812bf2a6d9b44122c807880a5cb3de403d4baa8e0fb352189dd1c
0x1c74c86906d91766e143e1d009C8604b66001363
</code></pre>
<h2 id="3-智能合约代码">3. 智能合约代码<a class="anchor" href="#3-智能合约代码">#</a></h2>
<pre><code class="language-solidity">pragma solidity ^0.8.13;

contract VerifySign{
  //公匙：0x1c74c86906d91766e143e1d009C8604b66001363
  //sha3(msg): 0x4e03657aea45a94fc7d47ba826c8d667c0d1e6e33a64a036ec44f58fa12d6c45 (web3.sha3(&quot;abc&quot;);)
  //签名后的数据：0x7eeb34fb6770d2b935de3657652e8060033ec47f57d10acbcc6a4b4d69f82db12d8ddd81e67a01a4a51a0e658760e895bab90a24cc0d7803800098be779ea1d91c

  //将原始数据按段切割出来指定长度
  function slice(bytes memory data, uint start, uint len) private returns (bytes memory) {
    bytes memory b = new bytes(len);

    for(uint i = 0; i &lt; len; i++){
      b[i] = data[i + start];
    }

    return b;
  }

  //bytes转换为bytes32
  function bytesToBytes32(bytes memory source) private returns (bytes32 result) {
    assembly {
        result := mload(add(source, 32))
    }
  }

    // &quot;\x19Ethereum Signed Message:\n{{len}}&quot;
  function VerifyMessageV1(bytes32 messageHash, uint8 _v, bytes32 _r, bytes32 _s) public pure returns (address signer) {
    signer = ecrecover(messageHash, _v, _r, _s);
  }

  address addr;
  bytes32 r; bytes32 s; uint8 v;
  function VerifyMessageV2(bytes32 messageHash, bytes memory signedString) public {
    r = bytesToBytes32(slice(signedString, 0, 32));
    s = bytesToBytes32(slice(signedString, 32, 32));
    v = uint8(slice(signedString, 64, 1)[0]);
    addr = ecrecover(messageHash, v, r, s);
  }

  function getSignCheckResult() public view returns (address _addr, bytes32 _r, bytes32 _s, uint8 _v){
    _addr = addr;
    _v = v;
    _r = r;
    _s = s;
  }
}
</code></pre>
<h2 id="4-部署智能合约到remix">4. 部署智能合约到remix<a class="anchor" href="#4-部署智能合约到remix">#</a></h2>
<p><a href="https://remix.ethereum.org/" 
  
   target="_blank" rel="noreferrer noopener" 
>https://remix.ethereum.org/</a></p>
<h2 id="5-执行verifymessagev1函数">5. 执行VerifyMessageV1函数<a class="anchor" href="#5-执行verifymessagev1函数">#</a></h2>
<p>输入参数：</p>
<pre><code class="language-json">{
    &quot;messageHash&quot;: &quot;0x50b2c43fd39106bafbba0da34fc430e1f91e3c96ea2acee2bc34119f92b37750&quot;,
    &quot;signedString&quot;: &quot;28&quot;,
    &quot;_r&quot;: &quot;0x5a0121bea4f2c1e9e6aad76bd3e06191a533c0b53a77df31e3b6310dbf4f698f&quot;,
    &quot;_s&quot;: &quot;0x17216a4bfd7cf812bf2a6d9b44122c807880a5cb3de403d4baa8e0fb352189dd&quot;,
}
</code></pre>
<p>返回结果：</p>
<pre><code class="language-json">{
    &quot;signer&quot;: &quot;0x1c74c86906d91766e143e1d009C8604b66001363&quot;,
}
</code></pre>
<p>signer和签名账户的地址一致</p>
<h2 id="6-执行verifymessagev2函数">6. 执行VerifyMessageV2函数<a class="anchor" href="#6-执行verifymessagev2函数">#</a></h2>
<p>输入参数：</p>
<pre><code class="language-json">{
    &quot;messageHash&quot;: &quot;0x50b2c43fd39106bafbba0da34fc430e1f91e3c96ea2acee2bc34119f92b37750&quot;,
    &quot;signedString&quot;: &quot;0x5a0121bea4f2c1e9e6aad76bd3e06191a533c0b53a77df31e3b6310dbf4f698f17216a4bfd7cf812bf2a6d9b44122c807880a5cb3de403d4baa8e0fb352189dd1c&quot;,
}
</code></pre>
<p>执行getSignCheckResult，返回结果：</p>
<pre><code class="language-json">{
    &quot;_addr&quot;: &quot;0x1c74c86906d91766e143e1d009C8604b66001363&quot;,
    &quot;_r&quot;: &quot;0x5a0121bea4f2c1e9e6aad76bd3e06191a533c0b53a77df31e3b6310dbf4f698f&quot;,
    &quot;_s&quot;: &quot;0x17216a4bfd7cf812bf2a6d9b44122c807880a5cb3de403d4baa8e0fb352189dd&quot;,
    &quot;_v&quot;: &quot;28&quot;,
}
</code></pre>
<p>_addr和签名账户的地址一致</p>


              
          </article>
          

 <div class="pagination">
  
    <a class="pagination__item" href="https://zhongxuqi.github.io/blockchain/2022-03-15/">
        <span class="pagination__label">Previous Post</span>
        <span class="pagination__title">打造以太坊私有链，合约的部署与使用</span>
    </a>
  

  
    <a class="pagination__item" href="https://zhongxuqi.github.io/blockchain/2022-08-18/">
      <span class="pagination__label">Next Post</span>
      <span class="pagination__title" >用Hardhat开发智能合约，并发布ERC20 Token</span>
    </a>
  
</div>

          
          <footer class="post__footer">
            


<div class="social-icons">
  
     
    
      <a
        class="social-icons__link"
        title="Twitter"
        href="https://twitter.com/zhongxuqi"
        target="_blank"
        rel="me noopener"
      >
        <div class="social-icons__icon" style="background-image: url('https://zhongxuqi.github.io/svg/twitter.svg')"></div>
      </a>
    
  
     
    
      <a
        class="social-icons__link"
        title="GitHub"
        href="https://github.com/zhongxuqi"
        target="_blank"
        rel="me noopener"
      >
        <div class="social-icons__icon" style="background-image: url('https://zhongxuqi.github.io/svg/github.svg')"></div>
      </a>
    
     
</div>

            <p></p>
          </footer>
          </div>
      </div>
      
    </div>
    

  </main>

   

  
  <script src="/js/index.min.301a8b0870381bf76b3b5182e8966d363a0474281183439beb024d8b8228fc66.js" integrity="sha256-MBqLCHA4G/drO1GC6JZtNjoEdCgRg0Ob6wJNi4Io/GY=" crossorigin="anonymous"></script>
  
  
  <script src="https://unpkg.com/prismjs@1.20.0/components/prism-core.min.js"></script>

  
  <script src="https://unpkg.com/prismjs@1.20.0/plugins/autoloader/prism-autoloader.min.js"
    data-autoloader-path="https://unpkg.com/prismjs@1.20.0/components/"></script>

  


</body>

</html>
